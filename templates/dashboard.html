{% extends 'basePlusNavbar.html' %}

{% block head %}
    <title>Dashboard</title>
{% endblock %}

{% block body %}
<body class='background_dashboard'>

    <div id='container'>

        <!-- LEFT PANEL -->
        <div class='sidePanel background border spacing'>
            
            <img class='resizeImg128' src='/static/avatars/{{ player["file_name"] }}'>

            <!-- Player Info Panel -->
            <div id='playerInfo'>
                <h3 class='alignCenter'><strong>{{ player['display_name'] }}</strong> ({{ player['player_level'] }})</h3>
                <h4><strong>{{ player['class_name'] }}</strong></h4>

                <hr>

                <div>
                    <table class='alignLeft'>
                        <tr>
                            <td>
                                <img class='iconImg' src='/static/icons/icon_honor.png'>
                                <p>{{ player['honor'] }}</p>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <img class='iconImg' src='/static/icons/icon_gold.png'>
                                <p id='playerGold'>{{ player['gold'] }}</p>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <img class='iconImg' src='/static/icons/icon_xp.png'>
                                <p>{{ player['exp_until_level'] }} / 150</p>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <img class='iconImg' src='/static/icons/icon_stamina.png'>
                                <p>{{ player['stamina'] }} / 100</p>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <hr>

            <div>
                <table class='leftRightTable'>
                    <tr>
                        <td>
                            <h5>Strength</h5>
                        </td>
                        <td>
                            <p id='playerStrength' class='sameLine'>{{ player['strength'] }}</p>
                            (<p id='playerPlusStrength' class='sameLine textGreen'>0</p>)
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <h5>Dexterity</h5>
                        </td>
                        <td>
                            <p id='playerDexterity' class='sameLine'>{{ player['dexterity'] }}</p>
                            (<p id='playerPlusDexterity' class='sameLine textGreen'>0</p>)
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <h5>Intelligence</h5>
                        </td>
                        <td>
                            <p id='playerIntelligence' class='sameLine'>{{ player['intelligence'] }}</p>
                            (<p id='playerPlusIntelligence' class='sameLine textGreen'>0</p>)
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <h5>Constitution</h5>
                        </td>
                        <td>
                            <p id='playerConstitution' class='sameLine'>{{ player['constitution'] }}</p>
                            (<p id='playerPlusConstitution' class='sameLine textGreen'>0</p>)
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <h5>Luck</h5>
                        </td>
                        <td>
                            <p id='playerLuck' class='sameLine'>{{ player['luck'] }}</p>
                            (<p id='playerPlusLuck' class='sameLine textGreen'>0</p>)
                        </td>
                    </tr>
                </table>

            </div>

            <hr>

            <div>
                <table class='leftRightTable'>
                    <tr>
                        <td>
                            <h5>Weapon Damage</h5>
                        </td>
                        <td>
                            <p id='playerDamage' class='sameLine'>0</p>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <h5>Health</h5>
                        </td>
                        <td>
                            <p id='playerHealth' class='sameLine'>0</p>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <h5>Armor</h5>
                        </td>
                        <td>
                            <p id='playerArmor' class='sameLine'>0</p>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <h5>Armor Reduction (%)</h5>
                        </td>
                        <td>
                            <p id='playerArmorReduc' class='sameLine'>0</p> / 100
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <h5>Critical Chance (%)</h5>
                        </td>
                        <td>
                            <p id='playerCritChance' class='sameLine'>0</p> / 100
                        </td>
                    </tr>
                </table>

            </div>
        </div>

        <!-- Main Panel -->
        <div class='mainPanel background border spacing'>

            <h3 class='header'><strong>Worn Items</strong></h3>

            <div class='inventory'>
                <div>
                    <img id='slot_helmet' src='/static/slots/slot_helmet.png'>
                    <img id='slot_chest' src='/static/slots/slot_chest.png'>
                    <img id='slot_legs' src='/static/slots/slot_legs.png'>
                    <img id='slot_gloves' src='/static/slots/slot_gloves.png'>
                    <img id='slot_boots' src='/static/slots/slot_boots.png'>
                    <img id='slot_weapon' src='/static/slots/slot_weapon.png'>
                    <img id='slot_offhand' src='/static/slots/slot_offhand.png'>
                </div>
            </div>

            <hr>

            <h3 class='header'><strong>Inventory</strong></h3>

            <form action="#" method="POST">
                <input type="submit" class="themeMediumButton" value="Create New Items">
            </form>

            <div class='inventory'>
                <div>

                {% for i in range(0,28) %}
                
                    {% if i < player['inventory_space'] %}
                        <img id='invSlot{{i}}' src='/static/slots/slot_empty.png'>
                    {% else %}
                        <img id='invSlot{{i}}' class='imgLocked' src='/static/slots/slot_locked.png'>
                    {% endif %}

                {% endfor %}

                </div>

                <!--
                <div>
                    <img class='itemBorderCommon' src='/static/weapons/dagger1.png'>
                    <img class='itemBorderUncommon' src='/static/weapons/dagger2.png'>
                    <img class='itemBorderRare' src='/static/weapons/maul1.png'>
                    <img class='itemBorderLegendary' src='/static/weapons/axe2.png'>
                    <img class='itemBorderUnique' src='/static/weapons/dagger1.png'>
                    <img class='itemBorderMythic' src='/static/weapons/maul2.png'>
                    <img src='/static/slots/slot_empty.png'>
                </div>
                -->
            </div>

        </div>

        <!-- RIGHT PANEL -->
        <div class='sidePanel background border spacing'>

            <!-- Player Stats Panel -->
            <div class='alignCenter'>
                
                <h3>Item Information</h3>

                <hr>

                <img id='panelImage' src='/static/slots/slot_empty.png'>

                <h4 id='panelPrefix'></h4>

                <h4 id='panelName' class='boldText'></h4>

                <h5 id='panelLevel'></h5>

                <h5 hidden id='panelWarning' class='textRed'>Stats Reduced - Wrong Class</h5>

                <table class='leftRightTable'>
                    <tr>
                        <td><h5>Weapon Dmg</h5></td>
                        <td>
                            <p id='panelDamage'></p>
                            (<p id='panelDamageDiff'></p>)
                        </td>
                    </tr>
                    <tr>
                        <td><h5>Armor</h5></td>
                        <td>
                            <p id='panelArmor'></p>
                             (<p id='panelArmorDiff'></p>)
                        </td>
                    </tr>
                    <tr>
                        <td><h5>Strength</h5></td>
                        <td>
                            <p id='panelStrength'></p>
                             (<p id='panelStrengthDiff'></p>)
                        </td>
                    </tr>
                    <tr>
                        <td><h5>Dexterity</h5></td>
                        <td>
                            <p id='panelDexterity'></p>
                             (<p id='panelDexterityDiff'></p>)
                        </td>
                    </tr>
                    <tr>
                        <td><h5>Intelligence</h5></td>
                        <td>
                            <p id='panelIntelligence'></p>
                             (<p id='panelIntelligenceDiff'></p>)
                        </td>
                    </tr>
                    <tr>
                        <td><h5>Constitution</h5></td>
                        <td>
                            <p id='panelConstitution'></p>
                             (<p id='panelConstitutionDiff'></p>)
                        </td>
                    </tr>
                    <tr>
                        <td><h5>Luck</h5></td>
                        <td>
                            <p id='panelLuck'></p>
                             (<p id='panelLuckDiff'></p>)
                        </td>
                    </tr>
                    <tr>
                        <td><h5>&nbsp;</h5></td>
                        <td><p>&nbsp;</p></td>
                    </tr>
                    <tr>
                        <td><h5>Worth</h5></td>
                        <td><p id='panelWorth'></p></td>
                    </tr>
                </table>

                <hr>

                <button hidden id='sellButton' class='themeMediumButton' onclick='processSellItem()'>Sell</button>
                <button hidden id='equipButton' class='themeMediumButton' onclick='processEquipItem()'>Equip</button>
                <button hidden id='unequipButton' class='themeMediumButton' onclick='processUnequipItem()'>Unequip</button>
            </div>
        </div>    
    </div>
    
{% endblock %}

{% block script %}
<script>

    var itemPanelConfig = {
        'panelPrefix': {'listKey': 'prefix', 'compareStats': false},
        'panelName': {'listKey': 'item_name', 'compareStats': false},
        'panelDamage': {'listKey': 'damage', 'compareStats': true},
        'panelArmor': {'listKey': 'armor', 'compareStats': true},
        'panelStrength': {'listKey': 'strength', 'compareStats': true},
        'panelDexterity': {'listKey': 'dexterity', 'compareStats': true},
        'panelIntelligence': {'listKey': 'intelligence', 'compareStats': true},
        'panelConstitution': {'listKey': 'constitution', 'compareStats': true},
        'panelLuck': {'listKey': 'luck', 'compareStats': true},
        'panelWorth': {'listKey': 'sell_price', 'compareStats': false}
    }

    var classInfo = {{ classInfo|tojson|safe }}
    var importedEquippedItems = {{ equippedItems|tojson|safe }}
    var importedInventoryItems = {{ items|tojson|safe }}

    var equippedItems = []
    var inventoryItems = []

    resetItemPanel()
    updatePlayerHealth()
    updatePlayerCritChance()

    for(var i=0; i<importedEquippedItems.length; i++)
        setupNewEquippedItem(importedEquippedItems[i])

    for(var i=0; i<importedInventoryItems.length; i++)
        setupNewInventoryItem(importedInventoryItems[i])


    //Adds the event listener to the item slot as well as assigns needed attributes
    function setupNewEquippedItem(item){
        var itemSlotId = getItemSlotTypeId(item['item_type_name'])

        var element = document.getElementById(itemSlotId)

        //Update the image in the worn slot
        element.src = 'static/' + item['file_name']
        element.classList = item['css_class_name']

        //Assign the necessary attributes
        var newIndex = equippedItems.length
        element.itemIndex = newIndex
        element.isEquipped = 1

        //Add the event listeners
        element.removeEventListener('click', showItemInPanel)
        element.addEventListener('click', showItemInPanel)

        //Add the equipment stats to the players total equipment stats
        changePlayerStats(item, 1)

        //Add the item to the equipped items 
        equippedItems.push(item)
    }


    //Adds the event listener to the item slot as well as assigns needed attributes
    function setupNewInventoryItem(item){
        var freeSlotId = getNextEmptyInventorySlot()
        var element = document.getElementById('invSlot' + freeSlotId)

        //Update the image in the inventory slot
        element.src = 'static/' + item['file_name']
        element.classList = item['css_class_name']

        element.itemIndex = freeSlotId
        element.isEquipped = 0

        element.removeEventListener('click', showItemInPanel)
        element.addEventListener('click', showItemInPanel)

        inventoryItems[freeSlotId] = item
    }


    //When an item from either the inventory or worn equipment is clicked - show the stats of the item in the item panel
    function showItemInPanel(){

        changeDisplayedButtons(this.isEquipped, this.itemIndex)

        if(this.isEquipped)
            updatePanelElements(equippedItems, this.itemIndex, this.isEquipped)
        else
            updatePanelElements(inventoryItems, this.itemIndex, this.isEquipped)
    }


    //Updates each of the item panel elements with the information of the item
    function updatePanelElements(itemsList, itemIndex, isEquipped){
        var equippedItem

        if(!isEquipped){
            var itemType = itemsList[itemIndex]['item_type_name']
            var slotType = getItemSlotTypeId(itemType)
            var equippedItemIndex = getEquippedItemIndex(itemType)

            if(equippedItemIndex != -1) 
                equippedItem = equippedItems[equippedItemIndex]
            else 
                equippedItem = null
        }

        document.getElementById('panelImage').src = 'static/' + itemsList[itemIndex]['file_name']
        document.getElementById('panelImage').classList = itemsList[itemIndex]['css_class_name']
        document.getElementById('panelLevel').innerText = 'Level ' + itemsList[itemIndex]['item_level'] + ' ' + itemsList[itemIndex]['item_type_name']

        //Check for wrong class stat to item type - warn them why their stats are reduced
        isWrongClassType(itemsList[itemIndex]['stat'])

        //Update each panel element based on the panel configuration
        Object.keys(itemPanelConfig).forEach(function(key) {
            var element = document.getElementById(key)
            var item = itemsList[itemIndex]
            var itemKey = itemPanelConfig[key]['listKey']

            element.innerText = item[itemKey]

            //Add or remove warning css color based on class type
            if(itemPanelConfig[key]['compareStats']){

                //Show the difference of stats between equipped item and inventory item
                var elementDiff = document.getElementById(key + 'Diff')

                if(!isEquipped && equippedItem != null){
                    var difference = item[itemKey] - equippedItem[itemKey]
                    elementDiff.innerText = difference

                    if(difference > 0)
                        elementDiff.classList = 'textGreen'
                    else if(difference == 0)
                        elementDiff.classList = ''
                    else
                        elementDiff.classList = 'textRed'
                    
                }
                //Reset the difference element text
                else{
                    elementDiff.innerText = '--'
                    elementDiff.classList = ''
                }
            }
        });
    }


    //Returns whether or not the item stat matches the players class stat
    function isWrongClassType(stat){

        if(classInfo['stat'] != stat){
            document.getElementById('panelWarning').hidden = false
            return true
        }

        document.getElementById('panelWarning').hidden = true
        return false
    }


    //Display panel buttons based on whether the item is from the inventory or worn equipment
    function changeDisplayedButtons(isEquipped, itemIndex){
        var sellButton = document.getElementById('sellButton')
        var equipButton = document.getElementById('equipButton')
        var unequipButton = document.getElementById('unequipButton')
        
        if(isEquipped){
            hideButtonAndRemoveItemId(equipButton)
            showButtonAndAddItemId(sellButton, itemIndex, isEquipped)
            showButtonAndAddItemId(unequipButton, itemIndex, isEquipped)
        }
        else{
            hideButtonAndRemoveItemId(unequipButton)
            showButtonAndAddItemId(sellButton, itemIndex, isEquipped)
            showButtonAndAddItemId(equipButton, itemIndex, isEquipped)
        }
    }


    //Handles the action of equipping something from the item panel
    function processEquipItem(){
        var itemIndex = document.getElementById('equipButton').itemIndex
        var slotType = inventoryItems[itemIndex]['item_type_name']
        var slotTypeId = getItemSlotTypeId(slotType)

        //Unequip old item
        var item = unequipItem(slotType, slotTypeId)

        //Equip new item
        equipItem(inventoryItems[itemIndex])

        //Remove new item from inventory
        removeItemFromInventory(itemIndex)

        //Add the item to the inventory only if one was unequipped
        if(item != null)
            setupNewInventoryItem(item)

        //var twoHanded = items[itemId]['is_two_handed']
        resetItemPanel()
    }


    //Handles the action of equipping something from the item panel
    function processUnequipItem(){
        var itemIndex = document.getElementById('unequipButton').itemIndex
        var slotType = equippedItems[itemIndex]['item_type_name']
        var slotTypeId = getItemSlotTypeId(slotType)

        //Unequip item
        var item = unequipItem(slotType, slotTypeId)

        //Add the item to the inventory only if one was unequipped
        if(item != null)
            setupNewInventoryItem(item)

        //var twoHanded = items[itemId]['is_two_handed']
        resetItemPanel()
    }


    //Handles the action of selling the item in the item panel
    function processSellItem(){
        var sellButton = document.getElementById('sellButton')
        var itemIndex = sellButton.itemIndex
        var isEquipped = sellButton.isEquipped
        var sellPrice = 0

        if(isEquipped){
            var slotType = equippedItems[itemIndex]['item_type_name']
            var slotTypeId = getItemSlotTypeId(slotType)

            sellPrice = equippedItems[itemIndex]['sell_price']

            unequipItem(slotType, slotTypeId)
        }
        else{
            sellPrice = inventoryItems[itemIndex]['sell_price']

            removeItemFromInventory(itemIndex)
        }

        //Update the players gold
        updateInnerText('playerGold', sellPrice)

        resetItemPanel()

        //TODO - send AJAX request that its sold
    }


    //Unequips the item, if exists, for the specified equipment slot - removing stats and adding it to the inventory
    function unequipItem(slotType, slotTypeId){
        //Check if item exists in that slot
        var itemIndex = getEquippedItemIndex(slotType)

        if(itemIndex != -1){
            //Get the item being unequipped
            var item = equippedItems[itemIndex]

            //Remove the stats from the player
            changePlayerStats(item, -1)

            //Remove the item from the equipped items list
            equippedItems[itemIndex] = null

            //Remove the item from the equipped slot
            var slot = document.getElementById(slotTypeId)
            slot.src = '/static/slots/' + slotTypeId + '.png'
            slot.classList = ''

            //Replaces with a deep clone - which doesn't have the event listeners
            slot.replaceWith(slot.cloneNode(true));

            //Make AJAX request that the item is now unequipped

            return item
        }
        else
            return null
    }


    //Removes the new item from the inventory
    function removeItemFromInventory(itemIndex){
        //Remove the item from the inventory grid
        var inventoryImg = document.getElementById('invSlot'+itemIndex)
        inventoryImg.src = '/static/slots/slot_empty.png'
        inventoryImg.classList = ''

        //Replaces with a deep clone - which doesn't have the event listeners
        inventoryImg.replaceWith(inventoryImg.cloneNode(true));

        //Remove the new item from the inventory list
        inventoryItems[itemIndex] = null
    }


    //Finds the next empty inventory slot
    function getNextEmptyInventorySlot(){
        for(var i=0; i<28; i++){
            if(document.getElementById('invSlot'+i).src.includes('locked')) break
            if(document.getElementById('invSlot'+i).src.includes('empty')) return i
        }
        return -1
    }


    //Equips the item for the specified equipment slot - adding stats and adding it to the equipment slot
    function equipItem(item){
        //Add the item to the equipment slot
        setupNewEquippedItem(item)

        //Make AJAX request that the item is now equipped
    }


    //Updates the players equipment totals by either subtracting or adding the value (based on the multipler supplied +1 or -1)
    function changePlayerStats(item, multiplier){


        updatePlayerArmorAndReduction(item['armor'], multiplier)

        //MAKE ITS OWN FUNCTION
        updateInnerText('playerDamage', item['damage'] * multiplier)
        
        updateInnerText('playerStrength', item['strength'] * multiplier)
        updateInnerText('playerDexterity', item['dexterity'] * multiplier)
        updateInnerText('playerIntelligence', item['intelligence'] * multiplier)
        updateInnerText('playerConstitution', item['constitution'] * multiplier)
        updateInnerText('playerLuck', item['luck'] * multiplier)

        updateInnerText('playerPlusStrength', item['strength'] * multiplier)
        updateInnerText('playerPlusDexterity', item['dexterity'] * multiplier)
        updateInnerText('playerPlusIntelligence', item['intelligence'] * multiplier)
        updateInnerText('playerPlusConstitution', item['constitution'] * multiplier)
        updateInnerText('playerPlusLuck', item['luck'] * multiplier)

        updatePlayerHealth()
        updatePlayerCritChance()
    }


    //Updates the players armor and armor reduction stats
    function updatePlayerArmorAndReduction(itemArmor, multiplier){
        var armor = itemArmor

        if(armor != 0){
            var classMaxArmorReduction = classInfo['max_armor_reduction'] * 100
            
            updateInnerText('playerArmor', armor * multiplier)

            armor = document.getElementById('playerArmor').innerText
            armorReduction = Math.floor(armor / '{{ player["player_level"] }}')

            if(armorReduction > classMaxArmorReduction)
                armorReduction = classMaxArmorReduction

            document.getElementById('playerArmorReduc').innerText = armorReduction
        }
    }


    //Updates the players health based on class multipler as well as constitution level
    function updatePlayerHealth(){
        var constitution = document.getElementById('playerConstitution').innerText
        var level = '{{ player["player_level"] }}'
        var health

        if(level <= 5)
			health = Math.floor(classInfo['health_modifier'] * (level ** 2) * 4 * (constitution/20) + 60)
		else
            health = Math.floor(classInfo['health_modifier'] * (level ** 2) * 4 * (constitution/30) + 60)

        document.getElementById('playerHealth').innerText = health
    }


    //Updates the players critical chance based on players luck
    function updatePlayerCritChance(){
        var luck = document.getElementById('playerLuck').innerText
        var critChance = Math.floor(luck / '{{ player["player_level"] }}')
        var classMaxCritChance = classInfo['max_crit_chance'] * 100

        if(critChance > classMaxCritChance)
            critChance = classMaxCritChance

        document.getElementById('playerCritChance').innerText = critChance
    }


    //Get the index of the equipped item (if exists) for the given slot type
    function getEquippedItemIndex(slotType){
        var slotTypeId = getItemSlotTypeId(slotType)
        for(var i=0; i<equippedItems.length; i++){
            if(equippedItems[i] == null) continue
            if(getItemSlotTypeId(equippedItems[i]['item_type_name']) == slotTypeId)
                return i
        }
        return -1
    }


    //Resets all of the item panels elements to the initial values
    function resetItemPanel(){
        document.getElementById('panelImage').src = '/static/slots/slot_empty.png'
        document.getElementById('panelImage').classList = '--'
        document.getElementById('panelLevel').innerText = '--'
        document.getElementById('panelWarning').hidden = true

        Object.keys(itemPanelConfig).forEach(function(key) {
            var element = document.getElementById(key)

            element.innerText = '--'
            element.classList.remove('textRed')

            if(itemPanelConfig[key]['compareStats']){
                var elementDiff = document.getElementById(key + 'Diff')
                
                elementDiff.innerText = '--'
                elementDiff.classList = ''
            }
        });

        document.getElementById('sellButton').hidden = true
        document.getElementById('equipButton').hidden = true
        document.getElementById('unequipButton').hidden = true
    }


    //Given a slot type, return the element id from the document
    function getItemSlotTypeId(itemSlotType){
        if(itemSlotType == 'Helmet')
            return 'slot_helmet'
        else if(itemSlotType == 'Chestplate')
            return 'slot_chest'
        else if(itemSlotType == 'Legs')
            return 'slot_legs'
        else if(itemSlotType == 'Gloves')
            return 'slot_gloves'
        else if(itemSlotType == 'Boots')
            return 'slot_boots'
        else if(itemSlotType == 'Shield')
            return 'slot_offhand'
        else
            return 'slot_weapon'
    }


    //===============================

    //Helper Functions

    //===============================


    //Returns the array without the object at the given index
    function removeArrayItem(arr, value){
        var index = arr.indexOf(value);
        if (index > -1){
            arr.splice(index, 1);
        }
        return arr;
    }


    //Updates a numerical field by a given amount
    function updateInnerText(id, increaseBy){
        var element = document.getElementById(id)
        var current = parseInt(element.innerText)

        if(typeof(current) !== 'number')
            return

        element.innerText = current + increaseBy
    }


    //Set hidden to true and remove the item id and the equipped bool off of the button
    function hideButtonAndRemoveItemId(button){
        button.hidden = true
        button.itemIndex = null
        button.isEquipped = null
    }


    //Set hidden to false and add the item id and the equipped bool to the button
    function showButtonAndAddItemId(button, itemIndex, isEquipped){
        button.hidden = false
        button.itemIndex = itemIndex
        button.isEquipped = isEquipped
    }

</script>
{% endblock %}